const F=document.getElementById("repo-path"),N=document.getElementById("api-key"),A=document.getElementById("github-username"),M=document.getElementById("github-token"),J=document.getElementById("save-config"),h=document.getElementById("config-status"),C=sessionStorage.getItem("benchmark_repo_path"),T=sessionStorage.getItem("openai_api_key"),S=sessionStorage.getItem("github_username"),$=sessionStorage.getItem("github_token");C&&(F.value=C);T&&(N.value=T);S&&(A.value=S);$&&(M.value=$);J?.addEventListener("click",()=>{const e=F.value.trim(),t=N.value.trim(),i=A.value.trim(),u=M.value.trim();e&&sessionStorage.setItem("benchmark_repo_path",e),t&&sessionStorage.setItem("openai_api_key",t),i&&sessionStorage.setItem("github_username",i),u&&sessionStorage.setItem("github_token",u),h&&(e||t||i||u)&&(h.style.display="block",h.className="status success",h.textContent="Configuration saved to session storage")});const j=document.getElementById("form-area"),H=document.getElementById("processing-area"),y=document.getElementById("files-input"),d=document.getElementById("files-dropzone"),w=document.getElementById("files-list"),Q=document.getElementById("process-btn"),m=document.getElementById("sorting-status"),I=document.getElementById("exam-groups"),r=document.getElementById("process-status"),D=document.getElementById("exam-logs");let l=[];d.addEventListener("click",()=>y.click());d.addEventListener("dragover",e=>{e.preventDefault(),d.style.borderColor="var(--accent)"});d.addEventListener("dragleave",()=>{d.style.borderColor="var(--border)"});d.addEventListener("drop",e=>{e.preventDefault(),d.style.borderColor="var(--border)",e.dataTransfer?.files&&U(Array.from(e.dataTransfer.files))});y.addEventListener("change",()=>{y.files&&U(Array.from(y.files))});function U(e){for(const t of e)l.some(i=>i.name===t.name)||l.push(t);R()}function R(){l.length>0?(w.innerHTML=l.map((e,t)=>`<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.25rem 0;">
            <span>${e.name}</span>
            <button type="button" data-index="${t}" class="remove-file" style="background: none; border: none; color: var(--muted); cursor: pointer; padding: 0 0.5rem;">&times;</button>
          </div>`).join(""),d.classList.add("has-file"),document.querySelectorAll(".remove-file").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const i=parseInt(t.target.dataset.index||"0");l.splice(i,1),R()})})):(w.innerHTML="",d.classList.remove("has-file"))}function V(){j.classList.add("collapsed"),H.style.display="block"}function P(){j.classList.remove("collapsed"),H.style.display="none",m.style.display="none",r.style.display="none",I.innerHTML="",D.innerHTML=""}Q.addEventListener("click",async()=>{if(l.length<2){alert("Please upload at least 2 files (exam and solutions).");return}const e=sessionStorage.getItem("openai_api_key")||"",t=sessionStorage.getItem("benchmark_repo_path")||"",i=document.getElementById("default-institution").value.trim(),u=document.getElementById("default-course").value.trim(),x=sessionStorage.getItem("github_username")||"",E=sessionStorage.getItem("github_token")||"";if(!e){alert("Please configure your OpenAI API key above.");return}V(),m.style.display="block",m.className="status loading",m.textContent="Matching files...";let o;try{const s=await fetch("/api/exams/sort-files",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileNames:l.map(n=>n.name),apiKey:e})});if(!s.ok)throw new Error("Failed to sort files");if(o=await s.json(),!o.exams||o.exams.length===0)throw new Error("Could not match any exam/solution pairs");m.className="status success",m.textContent=`Matched ${o.exams.length} exam(s)`,I.innerHTML=o.exams.map((n,f)=>`
          <div class="exam-group">
            <div class="exam-group-header">${n.inferred_name}</div>
            <div class="exam-group-files">
              <div>Questions: ${n.exam_file}</div>
              <div>Solutions: ${n.solutions_file}</div>
              ${n.reference_files?.length?`<div>References: ${n.reference_files.join(", ")}</div>`:""}
            </div>
          </div>
        `).join(""),o.unmatched&&o.unmatched.length>0&&(I.innerHTML+=`
            <div class="unmatched-files">
              Unmatched: ${o.unmatched.join(", ")}
            </div>
          `)}catch(s){m.className="status error",m.textContent=`Error: ${s}`,setTimeout(P,3e3);return}r.style.display="block",r.className="status loading",r.textContent=`Processing ${o.exams.length} exam(s)...`;const O=document.getElementById("notes").value.trim();D.innerHTML=o.exams.map((s,n)=>`
        <div class="exam-log" id="exam-log-${n}">
          <div class="exam-log-label">${s.inferred_name}</div>
          <div class="exam-log-content" id="exam-log-content-${n}"></div>
        </div>
      `).join("");const G=o.exams.map(async(s,n)=>{const f=document.getElementById(`exam-log-content-${n}`);try{const p=l.find(c=>c.name===s.exam_file),_=l.find(c=>c.name===s.solutions_file),K=s.reference_files?.map(c=>l.find(b=>b.name===c)).filter(Boolean)||[];if(!p||!_)throw new Error("Could not find matched files");const a=new FormData;a.append("examFile",p),a.append("solutionsFile",_),a.append("notes",O),a.append("apiKey",e),t&&a.append("repoPath",t),i&&a.append("institution",i),u&&a.append("course",u),x&&a.append("githubUsername",x),E&&a.append("githubToken",E);for(const c of K)a.append("referenceFiles",c);const B=await fetch("/api/exams/process",{method:"POST",body:a}),L=B.body?.getReader(),z=new TextDecoder;if(L)for(;;){const{done:c,value:b}=await L.read();if(c)break;const q=z.decode(b);f.textContent+=q,f.scrollTop=f.scrollHeight}return{index:n,success:B.ok,name:s.inferred_name}}catch(p){return f.textContent+=`
Error: ${p}`,{index:n,success:!1,name:s.inferred_name,error:p}}}),k=await Promise.all(G),g=k.filter(s=>s.success).length,v=k.length-g;v===0?(r.className="status success",r.textContent=`All ${g} exam(s) processed`):g===0?(r.className="status error",r.textContent=`All ${v} exam(s) failed`):(r.className="status warning",r.textContent=`${g} succeeded, ${v} failed`),setTimeout(P,4e3)});
