---
import Layout from '../layouts/Layout.astro';
---

<Layout title="System Intelligence Benchmark">
  <div id="form-area">
    <div class="block">
      <div class="block-header">Configuration</div>
      <p style="color: var(--muted); font-size: 0.75rem; margin-bottom: 1rem;">
        Configure GitHub credentials for this session.
      </p>

      <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);">
        <div style="font-size: 0.875rem; font-weight: 500; margin-bottom: 0.25rem;">GitHub Integration (Required)</div>
        <p style="color: var(--muted); font-size: 0.625rem; margin-bottom: 1rem;">
          Required to create a draft pull request
        </p>

        <label for="github-username">GitHub Username</label>
        <input type="text" id="github-username" placeholder="your-username" />

        <label for="github-token">GitHub Personal Access Token</label>
        <input type="text" id="github-token" placeholder="ghp_..." />
        <p style="color: var(--muted); font-size: 0.625rem; margin-top: 0.25rem; margin-bottom: 1rem;">
          Token needs repo write permissions. Creates branches and pushes commits automatically.
        </p>
      </div>

      <button id="save-config">Save Configuration</button>
      <div id="config-status" class="status" style="display: none;"></div>
    </div>

    <div class="block">
      <div class="block-header">Default Metadata</div>
      <p style="color: var(--muted); font-size: 0.75rem; margin-bottom: 1rem;">
        These values apply to all exams uploaded in this session.
      </p>
      <div class="row">
        <div style="flex: 1;">
          <label for="default-institution">Institution</label>
          <input type="text" id="default-institution" placeholder="University of Wisconsin-Madison" />
        </div>
        <div style="flex: 1;">
          <label for="default-course">Course</label>
          <input type="text" id="default-course" placeholder="CS 537" />
        </div>
      </div>
    </div>

    <div class="block">
      <div class="block-header">Upload Exam Files</div>
      <p style="color: var(--muted); font-size: 0.75rem; margin-bottom: 1rem;">
        Upload multiple exam and solution files. AI will automatically match them and process in parallel.
      </p>
      <div class="file-input" id="files-dropzone" style="min-height: 120px;">
        <span>Click or drag to upload exam and solution files</span>
        <input type="file" id="files-input" accept=".pdf,.txt" multiple />
        <div class="file-name" id="files-list"></div>
      </div>
    </div>

    <div class="block">
      <div class="block-header">Additional Notes</div>
      <label for="notes">Notes for AI Processing</label>
      <textarea id="notes" placeholder="Any specific instructions for parsing the exams (e.g., 'Questions 1-5 are multiple choice', 'Skip questions with figures')"></textarea>
    </div>

    <button id="process-btn" style="width: 100%;">Process and Add Exam(s)</button>
  </div>

  <div id="processing-area" style="display: none;">
    <div id="sorting-status" class="status loading" style="display: none;">Matching files...</div>
    <div id="exam-groups" style="margin-bottom: 1rem;"></div>

    <div id="process-status" class="status loading" style="display: none;">Processing...</div>
    <div id="exam-logs"></div>
  </div>

  <style>
    #form-area.collapsed {
      display: none;
    }
    .exam-group {
      border: 1px solid var(--border);
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }
    .exam-group-header {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    .exam-group-files {
      font-size: 0.75rem;
      color: var(--muted);
    }
    .exam-group-files div {
      margin: 0.125rem 0;
    }
    .exam-log {
      margin-bottom: 1.5rem;
    }
    .exam-log-label {
      font-size: 0.75rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
    }
    .exam-log-content {
      border: 1px solid var(--border);
      padding: 1rem;
      font-size: 0.8rem;
      white-space: pre-wrap;
      max-height: 500px;
      overflow-y: auto;
      line-height: 1.7;
      color: var(--muted);
    }
    .exam-log-content .step {
      color: var(--fg);
    }
    .unmatched-files {
      margin-top: 0.5rem;
      padding: 0.75rem;
      border: 1px solid var(--warning, #f59e0b);
      font-size: 0.75rem;
      color: var(--warning, #f59e0b);
    }
  </style>

  <script>
    // === Config Script ===
    const githubUsernameInput = document.getElementById('github-username') as HTMLInputElement;
    const githubTokenInput = document.getElementById('github-token') as HTMLInputElement;
    const saveBtn = document.getElementById('save-config');
    const configStatus = document.getElementById('config-status');

    const savedGithubUsername = sessionStorage.getItem('github_username');
    const savedGithubToken = sessionStorage.getItem('github_token');

    if (savedGithubUsername) githubUsernameInput.value = savedGithubUsername;
    if (savedGithubToken) githubTokenInput.value = savedGithubToken;

    saveBtn?.addEventListener('click', () => {
      const githubUsername = githubUsernameInput.value.trim();
      const githubToken = githubTokenInput.value.trim();

      if (githubUsername) sessionStorage.setItem('github_username', githubUsername);
      if (githubToken) sessionStorage.setItem('github_token', githubToken);

      if (configStatus && (githubUsername || githubToken)) {
        configStatus.style.display = 'block';
        configStatus.className = 'status success';
        configStatus.textContent = 'Configuration saved to session storage';
      }
    });

    // === Exam Upload Script ===
    interface ExamGroup {
      exam_file: string;
      solutions_file: string;
      reference_files?: string[];
      inferred_name: string;
    }

    interface SortResult {
      exams: ExamGroup[];
      unmatched?: string[];
    }

    const formArea = document.getElementById('form-area')!;
    const processingArea = document.getElementById('processing-area')!;
    const filesInput = document.getElementById('files-input') as HTMLInputElement;
    const filesDropzone = document.getElementById('files-dropzone')!;
    const filesList = document.getElementById('files-list')!;
    const processBtn = document.getElementById('process-btn') as HTMLButtonElement;
    const sortingStatus = document.getElementById('sorting-status')!;
    const examGroups = document.getElementById('exam-groups')!;
    const processStatus = document.getElementById('process-status')!;
    const examLogs = document.getElementById('exam-logs')!;

    let uploadedFiles: File[] = [];

    filesDropzone.addEventListener('click', () => filesInput.click());

    filesDropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      filesDropzone.style.borderColor = 'var(--accent)';
    });

    filesDropzone.addEventListener('dragleave', () => {
      filesDropzone.style.borderColor = 'var(--border)';
    });

    filesDropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      filesDropzone.style.borderColor = 'var(--border)';
      if (e.dataTransfer?.files) {
        addFiles(Array.from(e.dataTransfer.files));
      }
    });

    filesInput.addEventListener('change', () => {
      if (filesInput.files) {
        addFiles(Array.from(filesInput.files));
      }
    });

    function addFiles(newFiles: File[]) {
      for (const file of newFiles) {
        if (!uploadedFiles.some(f => f.name === file.name)) {
          uploadedFiles.push(file);
        }
      }
      updateFilesList();
    }

    function updateFilesList() {
      if (uploadedFiles.length > 0) {
        filesList.innerHTML = uploadedFiles.map((f, i) =>
          `<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.25rem 0;">
            <span>${f.name}</span>
            <button type="button" data-index="${i}" class="remove-file" style="background: none; border: none; color: var(--muted); cursor: pointer; padding: 0 0.5rem;">&times;</button>
          </div>`
        ).join('');
        filesDropzone.classList.add('has-file');

        document.querySelectorAll('.remove-file').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            const index = parseInt((e.target as HTMLElement).dataset.index || '0');
            uploadedFiles.splice(index, 1);
            updateFilesList();
          });
        });
      } else {
        filesList.innerHTML = '';
        filesDropzone.classList.remove('has-file');
      }
    }

    function collapseForm() {
      formArea.classList.add('collapsed');
      processingArea.style.display = 'block';
    }

    function expandForm() {
      formArea.classList.remove('collapsed');
      processingArea.style.display = 'none';
      sortingStatus.style.display = 'none';
      processStatus.style.display = 'none';
      examGroups.innerHTML = '';
      examLogs.innerHTML = '';
    }

    processBtn.addEventListener('click', async () => {
      if (uploadedFiles.length < 2) {
        alert('Please upload at least 2 files (exam and solutions).');
        return;
      }

      const defaultInstitution = (document.getElementById('default-institution') as HTMLInputElement).value.trim();
      const defaultCourse = (document.getElementById('default-course') as HTMLInputElement).value.trim();
      const githubUsername = sessionStorage.getItem('github_username') || '';
      const githubToken = sessionStorage.getItem('github_token') || '';

      if (!githubUsername || !githubToken) {
        alert('GitHub username and token are required to create the draft PR.');
        return;
      }

      collapseForm();

      sortingStatus.style.display = 'block';
      sortingStatus.className = 'status loading';
      sortingStatus.textContent = 'Matching files...';

      // Step 1: Sort files using AI
      let sortResult: SortResult;
      try {
        const sortResponse = await fetch('/api/exams/sort-files', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            fileNames: uploadedFiles.map(f => f.name)
          })
        });

        if (!sortResponse.ok) {
          throw new Error('Failed to sort files');
        }

        sortResult = await sortResponse.json();

        if (!sortResult.exams || sortResult.exams.length === 0) {
          throw new Error('Could not match any exam/solution pairs');
        }

        sortingStatus.className = 'status success';
        sortingStatus.textContent = `Matched ${sortResult.exams.length} exam(s)`;

        examGroups.innerHTML = sortResult.exams.map((exam, i) => `
          <div class="exam-group">
            <div class="exam-group-header">${exam.inferred_name}</div>
            <div class="exam-group-files">
              <div>Questions: ${exam.exam_file}</div>
              <div>Solutions: ${exam.solutions_file}</div>
              ${exam.reference_files?.length ? `<div>References: ${exam.reference_files.join(', ')}</div>` : ''}
            </div>
          </div>
        `).join('');

        if (sortResult.unmatched && sortResult.unmatched.length > 0) {
          examGroups.innerHTML += `
            <div class="unmatched-files">
              Unmatched: ${sortResult.unmatched.join(', ')}
            </div>
          `;
        }

      } catch (error) {
        sortingStatus.className = 'status error';
        sortingStatus.textContent = `Error: ${error}`;
        setTimeout(expandForm, 3000);
        return;
      }

      // Step 2: Process all exams in parallel
      processStatus.style.display = 'block';
      processStatus.className = 'status loading';
      processStatus.textContent = `Processing ${sortResult.exams.length} exam(s)...`;

      const notes = (document.getElementById('notes') as HTMLTextAreaElement).value.trim();

      examLogs.innerHTML = sortResult.exams.map((exam, i) => `
        <div class="exam-log" id="exam-log-${i}">
          <div class="exam-log-label">${exam.inferred_name}</div>
          <div class="exam-log-content" id="exam-log-content-${i}"></div>
        </div>
      `).join('');

      const processPromises = sortResult.exams.map(async (exam, index) => {
        const logContent = document.getElementById(`exam-log-content-${index}`)!;

        try {
          const examFile = uploadedFiles.find(f => f.name === exam.exam_file);
          const solutionsFile = uploadedFiles.find(f => f.name === exam.solutions_file);
          const referenceFiles = exam.reference_files?.map(name => uploadedFiles.find(f => f.name === name)).filter(Boolean) as File[] || [];

          if (!examFile || !solutionsFile) {
            throw new Error('Could not find matched files');
          }

          const formData = new FormData();
          formData.append('examFile', examFile);
          formData.append('solutionsFile', solutionsFile);
          formData.append('notes', notes);
          if (defaultInstitution) formData.append('institution', defaultInstitution);
          if (defaultCourse) formData.append('course', defaultCourse);
          if (githubUsername) formData.append('githubUsername', githubUsername);
          if (githubToken) formData.append('githubToken', githubToken);

          for (const ref of referenceFiles) {
            formData.append('referenceFiles', ref);
          }

          const response = await fetch('/api/exams/process', {
            method: 'POST',
            body: formData
          });

          const reader = response.body?.getReader();
          const decoder = new TextDecoder();

          if (reader) {
            while (true) {
              const { done, value } = await reader.read();
              if (done) break;
              const text = decoder.decode(value);
              logContent.textContent += text;
              logContent.scrollTop = logContent.scrollHeight;
            }
          }

          return { index, success: response.ok, name: exam.inferred_name };
        } catch (error) {
          logContent.textContent += `\nError: ${error}`;
          return { index, success: false, name: exam.inferred_name, error };
        }
      });

      const results = await Promise.all(processPromises);
      const successCount = results.filter(r => r.success).length;
      const failCount = results.length - successCount;

      if (failCount === 0) {
        processStatus.className = 'status success';
        processStatus.textContent = `All ${successCount} exam(s) processed`;
      } else if (successCount === 0) {
        processStatus.className = 'status error';
        processStatus.textContent = `All ${failCount} exam(s) failed`;
      } else {
        processStatus.className = 'status warning';
        processStatus.textContent = `${successCount} succeeded, ${failCount} failed`;
      }

      // Expand form back after a short delay
      setTimeout(expandForm, 4000);
    });
  </script>
</Layout>
